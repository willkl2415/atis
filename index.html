<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ATIS Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ---- EXACT SAME VISUAL LAYOUT YOU APPROVED ---- */
    body{background:#FFFF00;font-family:'Roboto',sans-serif;margin:0}
    .wrap{max-width:820px;margin:24px auto;padding:0 16px}
    .hero{background:#fff3;border-radius:6px;padding:18px 20px;margin-bottom:18px}
    h1{font-size:32px;margin:0 0 8px;font-weight:700;text-align:left}
    p{margin:0 0 10px;line-height:1.45}
    .label{background:#e6c43a;padding:8px 10px;border-radius:4px;margin:22px 0 8px;font-weight:700;width:100%}
    select,textarea{width:100%;box-sizing:border-box;padding:12px 12px;border:1px solid #ddd;border-radius:6px;font-size:16px;background:#fff}
    textarea{min-height:140px;resize:vertical}
    .btn{background:#deb62f;border:none;border-radius:6px;padding:12px 18px;font-size:16px;cursor:pointer;margin:16px 0}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .card{background:#fff;border-radius:8px;padding:18px 20px}
    .muted{background:#fff6c7;border-radius:8px;padding:14px 16px;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Welcome to ATIS — a simple concept with mind‑blowing results.</h1>
      <p>You have a question about your work, a task, a decision, or something you’re unsure about — and ATIS responds instantly with clear, helpful guidance. No setup, no jargon, no delay — just the answer you need, exactly when and where you need it.</p>
      <p>Whether you’re travelling, preparing for something important, solving a problem on the spot, or double‑checking a detail in the moment — ATIS is always ready.</p>
      <p>It’s the pinnacle of in‑the‑moment performance support — helping you feel more confident, capable, and informed, wherever you are.</p>
      <p><strong>ATIS isn’t just performance support — it’s the end of waiting for answers.</strong></p>
    </div>

    <div class="label">Sector</div>
    <select id="sector"><option value="">Select a sector</option></select>

    <div class="label">Function</div>
    <select id="function"><option value="">Select a function</option></select>

    <div class="label">Role</div>
    <select id="role"><option value="">Select a role</option></select>

    <div class="label">Prompt</div>
    <textarea id="prompt" placeholder="Write or copy and paste your question here"></textarea>

    <button id="submitBtn" class="btn">Submit Prompt</button>

    <div id="response" class="card" style="margin-top:12px;">No response received.</div>
    <div id="hint" class="muted" style="display:none;"></div>
  </div>

  <script src="roles.js"></script>
  <script>
    // ---- API settings ----
    const API_BASE = "https://atis-api.onrender.com";
    const ENDPOINT = "/generate";
    const HEALTH = "/health";

    // ---- DOM ----
    const sectorSelect = document.getElementById("sector");
    const functionSelect = document.getElementById("function");
    const roleSelect = document.getElementById("role");
    const promptInput = document.getElementById("prompt");
    const submitBtn = document.getElementById("submitBtn");
    const responseDiv = document.getElementById("response");
    const hintDiv = document.getElementById("hint");

    // ---- Populate from roles.js ----
    function populateSectors() {
      (window.ATIS_ROLES || []).forEach(sec => {
        const opt = document.createElement("option");
        opt.value = sec.sector;
        opt.textContent = sec.sector;
        sectorSelect.appendChild(opt);
      });
    }

    function populateFunctions() {
      functionSelect.innerHTML = "<option value=''>Select a function</option>";
      roleSelect.innerHTML = "<option value=''>Select a role</option>";
      const sector = (window.ATIS_ROLES || []).find(s => s.sector === sectorSelect.value);
      if (sector) {
        sector.functions.forEach(func => {
          const opt = document.createElement("option");
          opt.value = func.name;
          opt.textContent = func.name;
          functionSelect.appendChild(opt);
        });
      }
    }

    function populateRoles() {
      roleSelect.innerHTML = "<option value=''>Select a role</option>";
      const sector = (window.ATIS_ROLES || []).find(s => s.sector === sectorSelect.value);
      if (!sector) return;
      const func = sector.functions.find(f => f.name === functionSelect.value);
      if (func) {
        func.roles.forEach(role => {
          const opt = document.createElement("option");
          opt.value = role;
          opt.textContent = role;
          roleSelect.appendChild(opt);
        });
      }
    }

    sectorSelect.addEventListener("change", populateFunctions);
    functionSelect.addEventListener("change", populateRoles);

    // ---- Warm ping every 25s (keeps Render dyno hot) ----
    setInterval(() => {
      fetch(API_BASE + HEALTH, { mode: "cors" }).catch(() => {});
    }, 25000);

    // ---- Submit with a hard 6s client timeout ----
    async function submitPrompt() {
      const sector = sectorSelect.value;
      const func = functionSelect.value;
      const role = roleSelect.value;
      const prompt = promptInput.value.trim();

      if (!sector || !func || !role || !prompt) {
        responseDiv.textContent = "Please select sector, function, role, and enter a prompt.";
        return;
      }

      submitBtn.disabled = true;
      responseDiv.textContent = "Thinking…";
      hintDiv.style.display = "none";

      const ctrl = new AbortController();
      const to = setTimeout(() => ctrl.abort(), 6000); // 6s

      try {
        const res = await fetch(API_BASE + ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sector, func, role, prompt }),
          signal: ctrl.signal,
        });

        clearTimeout(to);

        if (!res.ok) {
          const msg = await res.text().catch(() => "");
          responseDiv.textContent = `Error: ${res.status} ${msg || res.statusText}`;
          hintDiv.textContent = "If this keeps happening, try again or shorten the question slightly.";
          hintDiv.style.display = "block";
          return;
        }

        const data = await res.json();
        responseDiv.textContent = data.text || "No response received.";
      } catch (err) {
        responseDiv.textContent = "Request cancelled or timed out at 6s. Please try again.";
        hintDiv.textContent = "ATIS is tuned for speed. Shorter prompts and stable connection help keep replies snappy.";
        hintDiv.style.display = "block";
      } finally {
        submitBtn.disabled = false;
      }
    }

    submitBtn.addEventListener("click", submitPrompt);

    // ---- Init ----
    populateSectors();
    // first warm ping right away
    fetch(API_BASE + HEALTH, { mode: "cors" }).catch(() => {});
  </script>
</body>
</html>
